esphome:
  name: "${name}"
  name_add_mac_suffix: true
  platformio_options:
    upload_speed: 921600
  includes:
  - neopixel-idf.h
  - firmware-ota.h
  - mqtt.h
  on_boot:
    then:
      - lambda: !lambda FirmwareInfo();
      - delay: 0.1s
      - light.control:
            id: leds
            state: on
            red: 1
            green: 0
            blue: 0
      - delay: 0.5s
      - light.control:
            id: leds
            state: on
            red: 1
            green: 0.7
            blue: 0
      - delay: 0.5s
      - light.control:
            id: leds
            state: on
            red: 0
            green: 1
            blue: 0
      - delay: 0.5s
      - light.control:
            id: leds
            state: off
      - lambda: |-
          mqttSetup();
  on_loop:
    then:
      - lambda: !lambda id(lcd_leds).set_wifi(id(wifi2).is_connected());

globals:
  - id: node_id
    type: int
    restore_value: true
    initial_value: '45'
  - id: co2Green
    type: int
    restore_value: true
    initial_value: '0'
  - id: co2Orange
    type: int
    restore_value: true
    initial_value: '800'
  - id: co2Red
    type: int
    restore_value: true
    initial_value: '1000'
  - id: co2DarkRed
    type: int
    restore_value: true
    initial_value: '1200'

wifi:
  id: wifi2

esp32_improv:
  id: improvConf
  authorizer: improvMgr

co2improv:
  id: improvMgr

logger:
  level: "${log_level}"

#web_server:
#  port: 80

mqtt:
  id: mqttclient
  broker: mqtt-dev.co2mon.nz
  username: co2monitor
  password: co2monitor
  discovery: false
  log_topic:
    topic: esphome/logs
    level: "${log_level}"

switch:
  - platform: factory_reset
    name: Restart with Factory Default Settings
    id: reset
    internal: true

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO0
      mode:
        input: true
      inverted: true
    name: Boot Button
    id: boot
    internal: true
    on_click:
      - max_length: 5s
        then:
          - lambda: |-
              improvMgr->startImprov();
      - min_length: 5s
        max_length: 20s
        then:
          - switch.turn_on: reset

sensor:
  - platform: scd4x
    id: scd40
    update_interval: "15s"
    co2:
      name: "CO2"
      id: co2
      on_value:
        - lambda: id(lcd_leds)->set_co2(x);
    temperature:
      name: "Temperature"
      id: temperature
      on_value:
        - lambda: id(lcd_leds)->set_temperature(x);
    humidity:
      name: "Humidity"
      id: humidity
      on_value:
        - lambda: id(lcd_leds)->set_humidity(x);

light:
- platform: custom
  lambda: |-
    auto np = new NeopixelIDF();
    App.register_component(np);
    return {np};

  lights:
    - name: "LEDs"
      id: leds
      default_transition_length: 0s
      internal: true
      restore_mode: "RESTORE_AND_OFF"

font:
  - file: "fonts/Roboto-Regular.ttf"
    id: roboto
    size: 15
  - file: "fonts/Roboto-Regular.ttf"
    id: roboto30
    size: 30
  - file: "fonts/Roboto-Regular.ttf"
    id: roboto10
    size: 10

display:
  - platform: co2display
    model: "SSD1306 128x64"
    id: lcd_leds
    rotation: "${display_rotation}"
    led_id: leds
    font_id: roboto
    font10_id: roboto10
    font30_id: roboto30
    threshold_green_id: co2Green
    threshold_orange_id: co2Orange
    threshold_red_id: co2Red

# Unused but required for dependency mgmt, so we can import it in co2display :(
qr_code:
  id: qr
  value: ""